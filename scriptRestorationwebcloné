#!/bin/bash
# Ce script doit être créé après la clé SSH pour l'utilisateur 'stark'.
# #!/bin/bash
# Script de restauration complète pour Serveur Web (192.168.56.10)
# Ce script DOIT être exécuté sur la machine de remplacement après un sinistre.

USER="stark"
HOST="192.168.56.3"
SOURCE="/mnt/backups/webserver"
IDENTITY_FILE="/home/stark/.ssh/id_rsa"
WEB_CONTENT="/var/www/entreprise.local"

echo "--- Démarrage de la Restauration complète depuis $HOST ---"

# 1. Restauration du contenu web et des configurations
echo "1/3. Restauration du contenu web et des Vhosts Nginx..."
# --delete est crucial pour garantir que le contenu de destination correspond exactement à la source
sudo rsync -avzu --delete -e "ssh -i $IDENTITY_FILE" "$USER"@"$HOST":"$SOURCE"/var/www/entreprise.local/ "$WEB_CONTENT"/

echo "Restauration des fichiers de configuration /etc/nginx/..."
sudo rsync -avzu -e "ssh -i $IDENTITY_FILE" "$USER"@"$HOST":"$SOURCE"/etc/nginx/ /etc/nginx/

echo "Restauration des configurations réseau et iptables..."
sudo rsync -avzu -e "ssh -i $IDENTITY_FILE" "$USER"@"$HOST":"$SOURCE"/etc/network/interfaces /etc/network/
sudo rsync -avzu -e "ssh -i $IDENTITY_FILE" "$USER"@"$HOST":"$SOURCE"/etc/iptables/ /etc/iptables/

# 2. Application des nouvelles configurations et redémarrage des services
echo "2/3. Application des nouvelles configurations..."
sudo netfilter-persistent reload 
sudo systemctl restart nginx
sudo systemctl restart networking # Pour s'assurer que l'IP/DNS est bien rechargé

echo "--- 3/3. Restauration terminée. Service Web en ligne ---"

#commande pour rendre le script executable sudo chmod +x /usr/local/bin/restore_web.sh